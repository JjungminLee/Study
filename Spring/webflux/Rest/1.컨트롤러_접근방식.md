```
@RestController
public class FluxAndMonoController {
   @GetMapping("/flux")
   public Flux<Integer> flux(){
      return Flux.just(1,2,3);
   }

}

@GetMapping("/mono")
public Mono<String> mono(){
   return Mono.just("Hello World").log();
}

```

## ë¬´í•œ ìŠ¤íŠ¸ë¦¼ API (SSE)

- ë¬´í•œ ìŠ¤íŠ¸ë¦¼ APIëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ë¡œë¶€í„° **ì§€ì†ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” ë°©ì‹** ì¤‘ í•˜ë‚˜
- ê·¸ì¤‘ í•˜ë‚˜ê°€ **SSE(Server-Sent Events)**ì´ë©°, ì´ëŠ” ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ **ë‹¨ë°©í–¥ìœ¼ë¡œ ë°ì´í„°ë¥¼ í‘¸ì‹œí•˜ëŠ” ë°©ì‹**

### **SSE(Server-Sent Events) íŠ¹ì§•**

- **HTTP ê¸°ë°˜**: ì¼ë°˜ì ì¸ HTTP ì—°ê²°ì„ ì‚¬ìš©í•˜ë©°, WebSocketê³¼ ë‹¬ë¦¬ ë³„ë„ì˜ í”„ë¡œí† ì½œì´ í•„ìš”í•˜ì§€ ì•ŠìŒ.
- **ë‹¨ë°©í–¥ í†µì‹ **: ì„œë²„ â†’ í´ë¼ì´íŠ¸ ë°©í–¥ìœ¼ë¡œë§Œ ë°ì´í„° ì „ì†¡ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ëŠ” X)
- **ìë™ ì¬ì—°ê²°**: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì—°ê²°ì„ ì‹œë„í•¨.
- **í…ìŠ¤íŠ¸ ê¸°ë°˜**: ì£¼ë¡œ JSONì´ë‚˜ í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë° ì í•©.
- **í”„ë¡ì‹œ ì¹œí™”ì **: ê¸°ì¡´ HTTP ì¸í”„ë¼(í”„ë¡ì‹œ, ë¡œë“œë°¸ëŸ°ì„œ ë“±)ì™€ í˜¸í™˜ì´ ì˜ë¨.

### http nio 2

```
2025-02-27T18:22:02.829+09:00  INFO 19490 --- [ctor-http-nio-2] reactor.Flux.Interval.1                  : onSubscribe(FluxInterval.IntervalRunnable)
2025-02-27T18:22:02.830+09:00  INFO 19490 --- [ctor-http-nio-2] reactor.Flux.Interval.1                  : request(1)
2025-02-27T18:22:03.837+09:00  INFO 19490 --- [     parallel-1] reactor.Flux.Interval.1                  : onNext(0)
2025-02-27T18:22:03.879+09:00  INFO 19490 --- [ctor-http-nio-2] reactor.Flux.Interval.1                  : request(31)
2025-02-27T18:22:04.834+09:00  INFO 19490 --- [     parallel-1] reactor.Flux.Interval.1                  : onNext(1)

```

- ë¦¬ì•¡í„° ìŠ¤ë ˆë“œ

### ì½”ë“œë¡œ ì‚´í´ë³´ê¸°

```
@GetMapping(value = "/stream",produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<Long> stream(){
   return Flux.interval(Duration.ofSeconds(1)).log();
}

```

- `produces = MediaType.TEXT_EVENT_STREAM_VALUE`: ì´ APIê°€ **SSE(Server-Sent Events)** ì‘ë‹µì„ ë°˜í™˜í•œë‹¤ëŠ” ëœ».
- ì¦‰ ì§€ì†ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìš”ì²­í•œë‹¤!
- **`return Flux.interval(Duration.ofSeconds(1)).log();`**
- `Flux.interval(Duration.ofSeconds(1))`
  - **ë§¤ 1ì´ˆë§ˆë‹¤** `Long` íƒ€ì… ìˆ«ìë¥¼ ìƒì„±í•˜ëŠ” **ë¬´í•œ ìŠ¤íŠ¸ë¦¼**ì„ ìƒì„±.

## í…ŒìŠ¤íŠ¸ì½”ë“œ

- ë‹¨ìœ„í…ŒìŠ¤íŠ¸
  - MockDataë¥¼ ì‚¬ìš©í•´ì„œ Controller or service ë“±ë“± ì¤‘ í•˜ë‚˜ì˜ ê³„ì¸µë§Œ í…ŒìŠ¤íŠ¸
  - íŠ¹ì • í´ë˜ìŠ¤ë§Œ í…ŒìŠ¤íŠ¸í•œë‹¤!
- í†µí•©í…ŒìŠ¤íŠ¸
  - Controller->Repository ì „ì²´ë‹¤ í…ŒìŠ¤íŠ¸

```

sourceSets{
    test{
        java.srcDirs = ['src/test/java/unit','src/test/java/intg']
    }
}

```

- ì´ë ‡ê²Œ build.gradleì— ì„¤ì •

## **@WebFluxTest**

`@WebFluxTest`ëŠ” **Spring WebFluxì˜ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ ì• ë„ˆí…Œì´ì…˜**ì´ì•¼.

Spring MVCì—ì„œ `@WebMvcTest`ê°€ ìˆëŠ” ê²ƒì²˜ëŸ¼, WebFluxì—ì„œëŠ” `@WebFluxTest`ê°€ ìˆìŒ.

### **ğŸ›  @WebFluxTest íŠ¹ì§•**

- **ë¹„ë™ê¸° ì»¨íŠ¸ë¡¤ëŸ¬ë§Œ ë¡œë“œ** (ì„œë¹„ìŠ¤, DB ì„¤ì • ì—†ì´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
- **`WebTestClient` ì œê³µ** â†’ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ê°€ì§œë¡œ í˜¸ì¶œí•´ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- **ë¦¬ì•¡í‹°ë¸Œ ìŠ¤í”„ë§ ì»¨íŠ¸ë¡¤ëŸ¬ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì— ì í•©**

## @WebTestClient

- Spring Webfluxì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸í• ë•Œ ì‚¬ìš©í•˜ëŠ” HTTPí´ë¼ì´ì–¸íŠ¸
- Fluxí…ŒìŠ¤íŠ¸

```
@Test
void flux() {
   webTestClient.get()
      .uri("/flux")
      .exchange()  // ìš”ì²­ì„ ì‹¤í–‰í•˜ê³  ì‘ë‹µë°›ìŒ
      .expectStatus()
      .is2xxSuccessful()
      .expectBodyList(Integer.class)  // ì‘ë‹µë°”ë””ë¥¼ List<Integer>ë¡œ
      .hasSize(3);
}

```

- Response Bodyë¥¼ í…ŒìŠ¤íŠ¸ í•˜ëŠ” ë˜ í•˜ë‚˜ì˜ ë°©ë²•

```
@Test
void flux2() {
   var flux = webTestClient.get()
      .uri("/flux")
      .exchange()
      .expectStatus()
      .is2xxSuccessful()
      .returnResult(Integer.class)
      .getResponseBody();
   StepVerifier.create(flux)
      .expectNext(1,2,3)
      .verifyComplete();
}

```

```java
	@Test
	void flux2() {
		var flux = webTestClient.get()
			.uri("/flux")
			.exchange()
			.expectStatus()
			.is2xxSuccessful()
			.expectBodyList(Integer.class)
			.consumeWith(listEntityExchangeResult -> {
				var responseBody = listEntityExchangeResult.getResponseBody();
				assert (responseBody.size()==3);
			});
	}
```

- Monoí…ŒìŠ¤íŠ¸

```java
@Test
	void mono() {
		var flux = webTestClient.get()
			.uri("/mono")
			.exchange()
			.expectStatus()
			.is2xxSuccessful()
			.expectBody(String.class)
			.consumeWith(stringEntityExchangeResult -> {
				var responseBody = stringEntityExchangeResult.getResponseBody();
				assertEquals("Hello World",responseBody);
			}
			);
	}
```

- SSE ë¬´í•œìŠ¤íŠ¸ë¦¼ í…ŒìŠ¤íŠ¸

```java
@Test
	void stream() {
		var flux = webTestClient.get()
			.uri("/stream")
			.exchange()
			.expectStatus()
			.is2xxSuccessful()
			.returnResult(Long.class) // ì‘ë‹µì„ Flux<Long>ìœ¼ë¡œ ë³€í™˜
			.getResponseBody();
		StepVerifier.create(flux)
			.expectNext(0L,1L,2L,3L)
			.thenCancel() // 0L ... 3Lê¹Œì§€ ë°›ê³  ê·¸ ì´í›„ì—ëŠ” ìŠ¤íŠ¸ë¦¼ì„ ì·¨ì†Œí•œë‹¤
			.verify();

	}
```
