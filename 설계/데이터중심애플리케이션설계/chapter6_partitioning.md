- 데이터셋이 매우 크거나 질의 처리량이 매우 높다면 복제만으로는 부족하고 파티션을 쪼갤 필요가 있다.
- 이런 작업을 샤딩이라고 한다
- 파티셔닝하는 이유?
  - 확장성
- 대표적으로 NoSQL에서 함

## 키-값 데이터 파티셔닝

- 대량의 데이터를 파티셔닝한다고 했을때 어떤 레코드를 어느 노드에 저장할지 어떻게 결정?
- 파티셔닝의 목적은 데이터와 질의 부하를 고르게 분산시키는거
  - 파티셔닝이 쏠리면 효과 떨어짐
  - 불균형하게 부하가 높은 파티션을 핫스팟이라고 함
  - 핫스팟 회피?
    - 레코드를 할당할 노드를 무작위 선택하기
    - 단점
      - 해당 레코드가 어떤 노드에 저장됐는지 알수 없어서 병렬적으로 질의해야

### 키 범위 파티셔닝

- 키가 정렬돼있고 개별 파티션은 어떤 최솟값과 최댓값 사이에 속하는 모든 키를 담당
- 키가 정렬돼있어 범위 질의가 효율적이나
- 애플리케이션에서 정렬순서가 서로 가까운 키에 자주 접근하면 핫스팟 생길 위험
- 보통 한 파티션이 너무 커지면 키의 범위를 두개로 쪼개 동적으로 재균형화

### 키의 해시값 기준 파티셔닝

- 좋은 해시함수는 쏠린 데이터를 입력으로 받아 균일하게 분산되게 함
- 카산드라와 몽고DB는 md5를 사용
- 해시 파티셔닝 - 키에 적합한 해시함수 구하면 각 파티션에 해시값 범위 할당하고, 해시값이 파티션의 범위에 속하는 모든 키를 그 파티션에 할당하면 된다 - 키를 파티션 사이에 균일하게 분산시키는데에 좋다 - CDN에서 부하를 균등하게 분산시키는 방법
  ||**해시 파티셔닝**|**범위 파티셔닝**|
  |---|---|---|
  |**방법**|키를 해시 함수로 변환하여 특정 파티션으로 매핑|키 값 자체의 범위를 기반으로 파티션 지정|
  |**장점**|데이터 균등 분산, 특정 값에 대한 빠른 조회|특정 범위 내에서의 범위 검색이 빠름|
  |**단점**|범위 검색이 어려움 (예: 특정 기간 내 데이터 조회)|특정 범위에 데이터가 집중될 위험|

- 해시 파티셔닝의 단점
  - 범위 질의를 효율적으로 사용하지 못함
  - 인접해썬 키들이 흩어져서 정렬순서 유지 되지 않음

## 파티셔닝과 보조색인

- 보조색인도 파티셔닝이 필요
- 문서 파티셔닝 색인
  - 보조 색인을 기본키와 값이 저장된 파티션에 저장
  - 쓸때는 하나의 파티션만 갱신
  - 보조 색인 읽으려면 모든 파티션에 걸쳐서 스캐터/게더를 실행해야

#### **1. 스캐터(Scatter)**

- **데이터 또는 요청을 여러 파티션(서버)으로 분산해서 보냄**.
- 즉, 한 곳에 있는 데이터가 아니라 여러 곳에 흩어져 있는 데이터를 가져와야 할 때, **여러 파티션에 요청을 보내는 과정**을 의미.
- 예제:
  - 보조 색인이 여러 파티션에 저장되어 있으면, **"모든 파티션을 검색해야 할 때"** 각 파티션에 쿼리를 보내는 것이 **스캐터** 과정이야.

#### **2. 게더(Gather)**

- **각 파티션에서 데이터를 검색한 후, 결과를 다시 모아서 반환하는 과정**.
- 즉, 여러 곳에 흩어진 데이터를 가져와 하나의 응답으로 합치는 것을 의미.
- 예제:
  - 모든 파티션에서 보조 색인 데이터를 검색한 후, 해당 결과를 한 곳으로 모아서 반환하는 것이 **게더** 과정이야.
- 용어 파티셔닝 색인
  - 색인된 값을 상요해서 보조 색인을 별도로 파티셔닝
  - 보조 색인 항목은 기본키의 모든 파티션에 있는 레코드 정보 포함할 수 있음
  - 문서를 쓸때는 보조 색인 여러개를 갱신해야하지만 읽기는 단일파티션에서 실행
