# 개념 다시 짚기

## **플러시(Flush)란?**

- 운영체제(OS)나 데이터베이스(DBMS)에서는 성능을 위해 **쓰기 연산을 바로 디스크에 기록하지 않고, 먼저 메모리(버퍼 캐시 또는 페이지 캐시)에 저장**.
- 이후 일정한 조건(예: 버퍼가 가득 차거나, 특정 시간이 지나거나, 강제 플러시 요청이 있을 때)이 충족되면 **메모리의 데이터를 디스크에 저장**하는 것이 **플러시(Flush)**

### 왜 플러시를 해야할까?

### 🔹 1. 성능 향상

- 디스크는 I/O 연산 속도가 메모리보다 훨씬 느리기 때문에, 작은 데이터를 즉시 디스크에 기록하면 속도가 느려짐.
- OS는 데이터를 **버퍼(Cache)에 먼저 저장한 후 일정량이 쌓이면 한 번에 디스크에 기록**하여 성능을 최적화함.
- **랜덤 I/O를 순차적 I/O로 변환**하여 성능 향상 효과도 있음.

### 🔹 2. 데이터 손실 방지

- 만약 OS가 **메모리에서만 데이터를 가지고 있다가 시스템이 갑자기 꺼지면(예: 전원 차단)**, 데이터가 손실될 수 있음.
- 따라서 **플러시를 통해 데이터를 디스크에 저장해야 안전하게 유지**됨.

### **랜덤 I/O(Random I/O)**

- 데이터가 디스크의 여러 위치에 흩어져 있어 **헤드(헤더)가 여러 번 움직이며 데이터를 읽고 써야 하는 방식**.
- 예를 들어, 여러 개의 작은 파일을 여기저기 저장하는 경우.
- **속도가 느림** (디스크 헤드 이동이 많아지는 "시킹(Seeking)"이 많아짐).

### 🔹 **순차적 I/O(Sequential I/O)**

- 데이터가 디스크 상에서 연속된 위치에 저장되며, **헤드가 연속적으로 읽거나 쓰는 방식**.
- 예를 들어, **큰 파일을 한 번에 저장하는 경우**.
- **속도가 빠름** (헤드 이동이 최소화됨).

@todo : 파일 처리 내용 다시 보기!

## 메모리 사용량 설정

- innodb_dedicated_server를 사용하면 일반적으로 RAM의 50~75%를 사용
- MySQL은 연결을 열린상태로 유지하기 위해 소량의 메모리가 필요
  - 쿼리를 실행할수 있도록 메모리를 따로 확보
- 운영체제에 메모리가 충분하다는 것을 나타내는 가장 좋은 표시
  - 가상 메모리를 디스크로 스와핑하지 않는다는 것

## InnoDB 버퍼 풀

- 성능에 가장 중요한 변수이기에 메모리가 필요
- 인덱스 캐싱, 행 데이터, 잠금 등등 내부구조 저장
- 쓰기 지연을 위해 버퍼 풀을 사용
- 만약 버퍼 풀에 더피(수정된)페이지가 많은 경우?
  - 더티 페이지를 데이터 파일에 기록해야하기에 많은 시간이 걸릴것
  - 강제로 빠르게 종료할수도 있지만 재시작 시에 복구해야하기 때문에 시간이 더 걸림
  - innodb_max_dirty_pages_pct 변수를 낮은 값으로 변경하고 플러시 스레드가 버퍼풀을 정리할 때까지 기다렸다가 더티 페이지수가 줄어들면 종료하면 된다!

## 스레드 캐시

- 현재 연결된 스래드와 연결되어 있지만 새 연결을 제공할 준비가 된 스레드를 보유한다.
- 캐시에 스레드가 있고 새로운 연결이 생성될 때 MySQL은 캐시에서 스레드를 제거하고 새 연결에 제공한다. 연결이 닫히면 MySQL은 여유공간이 있는 경우 스레드를 캐시에 보관
- 스레드 캐시를 매우 크게 설정하는건 대부분의 경우에 필요없지만 작게 유지하는 것은 메모리를 많이 절약하지 않기에 이점이 없다

## MySQL의 I/O동작 설정

- InnoDB는 트랜잭션 커밋 비용을 줄이기 위해 로그를 사용
  - 각 트랜잭션이 커밋될때 버퍼 풀을 디스크로 플러시하는 대신 트랜잭션을 로그로 남김
  - 로그를 사용해서 랜덤 쓰기를 순차 쓰기로 변환
- 로그 버퍼
  - 데이터 변경 시 변경 기록을 로그 버퍼에 기록해 메모리에 보관
  - 로그버퍼를 디스크의 로그 파일로 플러시할 때 뮤텍스로 버퍼를 잠그고 원하는 지점까지 플러시한 다음 나머지 항목을 버퍼의 앞으로 이동
  - 로그 버퍼를 로그파일에 쓰기 vs 영구저장소에 플러시
    - 로그 파일에 쓰기
      - InnoDB의 메모리 버퍼에서 메모리에 있는 운영체제의 캐시로 이동
        - 실제로 영구저장소에 쓰는게 아님!

## InnoDB 테이블 스페이스

- 테이블 스페이스가 뭐지?
  - **데이터를 저장하는 논리적/물리적 단위**.
  - InnoDB는 데이터를 **페이지(Page) 단위**로 저장함.
    - 기본적으로 **InnoDB의 한 페이지 크기는 16KB**
- 본질적으로 디스크에 있는 한개또는 많은 파일을 포괄하는 가상 파일시스템인 테이블 스페이스에 데이터 보관
  - 인덱스 저장뿐만 아니라 undo로그, 변경 버퍼, 더블라이트 버퍼 및 기타 내부구조를 테이블 스페이스에 유지
- 쓰기 작업이 많은 환경에서 매우 커질 수 있다!

## 동시성 설정

- 데이터를 샤딩하기
- 스레드가 데이터에 엑세스하기 위해
  - 커널에 들어가는 방법
  - 커널 내부에 있을때 수행할 수 있는 작업을 제어하는 자체 스케쥴러가 존재
-
